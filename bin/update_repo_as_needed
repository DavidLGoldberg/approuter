#! /usr/bin/env bash
function log(){
    echo "`date` - ${1}"
}
################################################################################
#
# can be used to check and update (as needed) a git repository
# if invoked with no parameters the current directory will be checked and, if
# it's a git repo with remote changes available, updated
#
# usage:
#   update_repo_as_needed [expand] [directory]
#
################################################################################
ACTION=$1
case $ACTION in
    '-h')
        ACTION=help
        ;;
    '--help')
        ACTION=help
        ;;
    expand)
        ;;
    *)
        # don't know what it is, must be trying to give us a dir
        REPO_DIR=$ACTION
        # currently this action triggers nothing explicitly this is
        # only here because I suck
        ACTION=update
        ;;
esac

if [ $ACTION == "help" ]; then
    echo "`basename $0` [expand] [directory]"
    echo "    expand - causes the output of the full path to the script and the"
    echo "       repo directories to be sent to stdout, used to facilitate"
    echo "       creating crontab entries"
    echo "    directory - optional repository directory to check, if not "
    echo "       provided the current directory is checked"
    exit 0
fi

shift
if [ "${REPO_DIR}x" == "x" ]; then
    REPO_DIR=$1
fi
if [ "${REPO_DIR}x" == "x" ]; then
    # no dir provided, assume current directory
    REPO_DIR=`pwd`
fi

cd ${REPO_DIR}
# want to get the full directory for our repo
REPO_DIR=`pwd`


git rev-parse --git-dir >> /dev/null 2>&1
if [ $? -ne 0 ]; then
    log "${REPO_DIR} doesn't appear to be a git repo, nothing to do"
    exit 1
fi

if [ $ACTION == "expand" ]; then
    printf "* * * * *\t$0 $REPO_DIR"
    exit 0
fi

FETCH_RESULTS=`git fetch --all `
if [ $? -ne 0 ]; then
    echo "fetch error"
    echo $FETCH_RESULTS
fi
CURRENT_BRANCH=`git rev-parse --symbolic-full-name --abbrev-ref HEAD`
CURRENT_SHA=`git log -n 1 --no-merges --pretty=format:%h`
ORIGIN_URL=`git config remote.origin.url`
HAS_CHANGES=`git diff HEAD...origin/${CURRENT_BRANCH} --raw`

log "checking ${REPO_DIR} for any available changes from ${ORIGIN_URL}"
if [ "${HAS_CHANGES}x" == "x" ]; then
    log "no changes, nothing to update"
else
    log "deploying changes for branch ${CURRENT_BRANCH} from ${ORIGIN_URL}"
    git reset --hard origin/${CURRENT_BRANCH}
fi
