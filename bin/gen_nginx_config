#! /usr/bin/env bash
MY_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
if [ "${ENVIRONMENT_SOURCED}x" = "x" ]; then
  source ${MY_DIR}/environment
fi

while read instance_name
do
    IFS=`printf "\t"`;
    declare -a parts=(${instance_name})
    TYPE=${parts[0]}
    NAME=${parts[1]}
    PORT=${parts[2]}
    UPSTREAM_CONF_FILE=${NGINX_CONF_ROOT}/upstream_${TYPE}_${NAME}
    ROUTE_CONF_FILE=${NGINX_CONF_ROOT}/route_${TYPE}_${NAME}
    COOKIE_CONF_FILE=${NGINX_CONF_ROOT}/${TYPE}_cookie_locations_${NAME}
    ROUTING_COOKIE_NAME=${ALTERNATE_ROUTE_COOKIE_PREFIX}_${NAME}
    rm -f ${UPSTREAM_CONF_FILE}
    rm -f ${ROUTE_CONF_FILE}
    if [ $TYPE == "prod" ]; then
        echo "upstream production {" >> ${UPSTREAM_CONF_FILE}
    else
        echo "upstream alternate_${NAME} {" >> ${UPSTREAM_CONF_FILE}
    fi
    echo "  server 127.0.0.1:${PORT};" >> ${UPSTREAM_CONF_FILE}
    echo "}" >> ${UPSTREAM_CONF_FILE}

    # our alternates need to have their proxy route configs generated
    if [ $TYPE == "alternates" ]; then
        echo "if (\$http_cookie ~* \"${ROUTING_COOKIE_NAME}\"){" >> ${ROUTE_CONF_FILE}
        echo "  proxy_pass http://alternate_${NAME};" >> ${ROUTE_CONF_FILE}
        echo "  add_header X-SERVED-BY-ALT ${NAME};" >> ${ROUTE_CONF_FILE}
        echo "}" >> ${ROUTE_CONF_FILE}

        # creating our alt cookie control locations so there is a convenient place to
        # get the routing cookie set and removed
        echo "location = /set_alt_cookie_${NAME}.html {" > ${COOKIE_CONF_FILE}
        echo "  add_header Set-Cookie \"${ROUTING_COOKIE_NAME}=${NAME}; path=/; expires=9999999999;\";" >> ${COOKIE_CONF_FILE}
        echo "  return 200 \"Have a cookie!\";" >> ${COOKIE_CONF_FILE}
        echo "}" >> ${COOKIE_CONF_FILE}
        echo "location = /remove_alt_cookie_${NAME}.html {" >> ${COOKIE_CONF_FILE}
        #echo "  add_header Set-Cookie \"${ROUTING_COOKIE_NAME}=${NAME}; path=/; expires=0000000001;\";" >> ${COOKIE_CONF_FILE}
        echo "  add_header Set-Cookie \"${ROUTING_COOKIE_NAME}=${NAME}; path=/; Max-Age=0;\";" >> ${COOKIE_CONF_FILE}
        echo "  return 200 \"Gimme that cookie!\";" >> ${COOKIE_CONF_FILE}
        echo "}" >> ${COOKIE_CONF_FILE}
    fi
done < ${RUN_DATA_FILE}

cat ${NGINX_CONF_TEMPLATE_1} | \
  sed -e s[{{conf_dir}}[${NGINX_CONF_ROOT}[g | \
  sed -e s[{{log_dir}}[${LOG_DIR}[g  | \
  sed -e s[{{cache_dir}}[${CACHE_DIR}[g  | \
  sed -e s[{{temp_dir}}[${TEMP_DIR}[g  | \
  sed -e s[{{storage_root}}[${STORAGE_ROOT}[g  | \
  sed -e s[{{run_dir}}[${RUN_DIR}[g > ${NGINX_CONF_FILE_1}
cat ${NGINX_CONF_TEMPLATE_2} | \
  sed -e s[{{conf_dir}}[${NGINX_CONF_ROOT}[g | \
  sed -e s[{{log_dir}}[${LOG_DIR}[g  | \
  sed -e s[{{cache_dir}}[${CACHE_DIR}[g  | \
  sed -e s[{{temp_dir}}[${TEMP_DIR}[g  | \
  sed -e s[{{storage_root}}[${STORAGE_ROOT}[g  | \
  sed -e s[{{run_dir}}[${RUN_DIR}[g > ${NGINX_CONF_FILE_2}
cp templates/mime.types ${NGINX_CONF_ROOT}
