#! /usr/bin/env bash
silent_pushd(){ pushd $1 > /dev/null 2>&1; }
silent_popd(){ popd $1 > /dev/null 2>&1 ; }
log(){ echo $1 >&2; }

get_repo_sha(){
  REPO_DIR=${1?You must provide a path to a repo}
  silent_pushd ${REPO_DIR}
  REPO_SHA=`git log -1 --oneline | awk '{ print $1 }'`
  silent_popd
}

ROOT=${APPROUTER_ROOT}
MANAGED_ROOT=${ROOT}/managed
APPROUTER_BIN_DIR=${ROOT}/bin
BUILD_ROOT=${ROOT}/build_output
SBIN_DIR=${BUILD_ROOT}/sbin
CONF_ROOT=${ROOT}/etc
INSTANCE_GROUP_ROOT=${MANAGED_ROOT}/app_instances
VAR_DIR=${MANAGED_ROOT}/var
NGINX_CACHE_DIR=${VAR_DIR}/cache/nginx
LOG_DIR=${VAR_DIR}/log
RUN_DIR=${VAR_DIR}/run
TEMP_DIR=${VAR_DIR}/temp
PERP_BASE=${MANAGED_ROOT}/etc/perp
RUNTIME_BIN_DIR=${VAR_DIR}/bin
GENERATED_CONF_DIR=${VAR_DIR}/conf
LOGROTATE_CONF_TEMPLATE=${ROOT}/templates/logrotate.conf
LOGROTATE_CONF=${GENERATED_CONF_DIR}/logrotate.conf
TEMPLATE_DIR=${ROOT}/templates
INSTANCE_DATE_FORMAT="%Y-%m-%dT%H_%M_%S%z"

NGINX_PIDFILE=${RUN_DIR}/nginx.pid
NGINX_CONF_ROOT=${GENERATED_CONF_DIR}/nginx
NGINX_CONF_LINK=${GENERATED_CONF_DIR}/nginx/nginx.conf
NGINX_CONF_FILE=${GENERATED_CONF_DIR}/nginx/nginx.conf
NGINX_PORT=9090

mkdir -p ${GENERATED_CONF_DIR}
mkdir -p ${INSTANCE_GROUP_ROOT}
mkdir -p ${NGINX_CONF_ROOT}
mkdir -p ${RUNTIME_BIN_DIR}
mkdir -p ${NGINX_CACHE_DIR}
mkdir -p ${TEMP_DIR}
mkdir -p ${PERP_BASE}
mkdir -p ${LOG_DIR}
mkdir -p ${RUN_DIR}

export -f silent_pushd
export -f silent_popd
export -f log

ENVIRONMENT_SOURCED=1
