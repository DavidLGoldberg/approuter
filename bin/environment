#! /usr/bin/env bash
silent_pushd(){ pushd $1 > /dev/null 2>&1; }
silent_popd(){ popd $1 > /dev/null 2>&1 ; }

function set_instance_name_from_dir(){
  INSTANCE_DIR=$1
  INSTANCE_NAME=`basename $1`
}

function set_instance_start_control_file_path(){
  INSTANCE_PATH=$1
  START_CTL_FILE=${RUNTIME_BIN_DIR}/start_${INSTANCE_NAME}
  # this is the name of a helper file that can be called and will
  # block until the requested instance is running, or will timeout 
  # after some defined interval
  WAIT_FOR_START_FILE=${RUNTIME_BIN_DIR}/wait_for_${INSTANCE_NAME}
}

function set_instance_stop_control_file_path(){
  INSTANCE_PATH=$1
  STOP_CTL_FILE=${RUNTIME_BIN_DIR}/stop_${INSTANCE_NAME}
}

function set_directory_branch_name(){
  DIR_BRANCH_NAME=`git rev-parse --symbolic-full-name --abbrev-ref HEAD`
}

function get_instance_group_sha(){
  INSTANCE_GROUP=${1?You must provide an instance group to get_instance_group_sha()}
  silent_pushd ${INSTANCE_GROUP_ROOT}
  INSTANCE_GROUP_SHA=`git log -1 --oneline | awk '{ print $1 }'`
  silent_popd
}

ROOT=${APPROUTER_ROOT}
MANAGED_ROOT=${ROOT}/managed
APPROUTER_BIN_DIR=${ROOT}/bin
BUILD_ROOT=${ROOT}/build_output
SBIN_DIR=${BUILD_ROOT}/sbin
CONF_ROOT=${ROOT}/etc
PROD_BRANCH_CONF=${CONF_ROOT}/prod_branch
HEALTH_CHECK_URL_CONF=${CONF_ROOT}/health_check
ALTERNATES_ROOT=${MANAGED_ROOT}/alternates
ALTERNATES_CONF=${CONF_ROOT}/alternates.conf
ALTERNATE_ROUTE_COOKIE_PREFIX=arcp
PROD_ROOT=${MANAGED_ROOT}/prod
INSTANCE_GROUP_ROOT=${MANAGED_ROOT}/app_instances
ACTIVE_INSTANCE_LINK=${INSTANCE_GROUP_ROOT}/active
VAR_DIR=${MANAGED_ROOT}/var
ENV_SETTINGS_REPO_DIR=${MANAGED_ROOT}/env-settings
NGINX_CACHE_DIR=${VAR_DIR}/cache/nginx
LOG_DIR=${VAR_DIR}/log
RUN_DIR=${VAR_DIR}/run
TEMP_DIR=${VAR_DIR}/temp
PERP_BASE=${MANAGED_ROOT}/etc/perp
RUNTIME_BIN_DIR=${VAR_DIR}/bin
RUN_DATA_FILE=${VAR_DIR}/run_data
REPO_CONF=${CONF_ROOT}/repo.conf
ENV_SETTINGS_REPO_CONF=${CONF_ROOT}/env_repo.conf
GENERATED_CONF_DIR=${VAR_DIR}/conf
LOGROTATE_CONF_TEMPLATE=${ROOT}/templates/logrotate.conf
LOGROTATE_CONF=${GENERATED_CONF_DIR}/logrotate.conf
TEMPLATE_DIR=${ROOT}/templates

NGINX_PIDFILE=${RUN_DIR}/nginx.pid
NGINX_CONF_ROOT=${GENERATED_CONF_DIR}/nginx
NGINX_CONF_LINK=${GENERATED_CONF_DIR}/nginx/nginx.conf
NGINX_ACTIVE_CONFIG=`readlink ${NGINX_CONF_LINK}`
NGINX_CONF_FILE=${GENERATED_CONF_DIR}/nginx/nginx.conf
NGINX_PORT=9090

mkdir -p ${GENERATED_CONF_DIR}
mkdir -p ${INSTANCE_GROUP_ROOT}
mkdir -p ${NGINX_CONF_ROOT}
mkdir -p ${RUNTIME_BIN_DIR}
mkdir -p ${NGINX_CACHE_DIR}
mkdir -p ${TEMP_DIR}
mkdir -p ${PERP_BASE}
mkdir -p ${LOG_DIR}
mkdir -p ${RUN_DIR}

export -f set_instance_name_from_dir
export -f set_instance_start_control_file_path
export -f set_instance_stop_control_file_path
export -f silent_pushd
export -f silent_popd

ENVIRONMENT_SOURCED=1
